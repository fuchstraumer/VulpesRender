
MACRO(ADD_MSVC_PRECOMPILED_HEADER PrecompiledHeader PrecompiledSource SourcesVar)
  IF(MSVC)
    GET_FILENAME_COMPONENT(PrecompiledBasename ${PrecompiledHeader} NAME_WE)
    SET(PrecompiledBinary "${CMAKE_CURRENT_BINARY_DIR}/${PrecompiledBasename}.pch")
    SET(Sources ${${SourcesVar}})

    SET_SOURCE_FILES_PROPERTIES(${PrecompiledSource}
                                PROPERTIES COMPILE_FLAGS "/Yc\"${PrecompiledHeader}\" /Fp\"${PrecompiledBinary}\""
                                           OBJECT_OUTPUTS "${PrecompiledBinary}")
    SET_SOURCE_FILES_PROPERTIES(${Sources}
                                PROPERTIES COMPILE_FLAGS "/Yu\"${PrecompiledHeader}\" /FI\"${PrecompiledHeader}\" /Fp\"${PrecompiledBinary}\""
                                           OBJECT_DEPENDS "${PrecompiledBinary}")  
    # Add precompiled header to SourcesVar
    LIST(APPEND ${SourcesVar} ${PrecompiledSource})
  ENDIF(MSVC)
ENDMACRO(ADD_MSVC_PRECOMPILED_HEADER)

INCLUDE(ExternalProject)
CMAKE_MINIMUM_REQUIRED(VERSION 3.6)
PROJECT(VulpesRender)

SET_PROPERTY(GLOBAL PROPERTY USE_FOLDERS ON)
SET(CMAKE_EXPORT_COMPILE_COMMANDS ON)

SET(CMAKE_CXX_STANDARD LATEST)
SET(CMAKE_CXX_STANDARD_REQUIRED ON)

IF(MSVC)
  OPTION(USE_MSVC_RUNTIME_LIBRARY_DLL "Use MSVC runtime DLL" ON)
ENDIF()

ExternalProject_Add(assimp
  PREFIX "${CMAKE_CURRENT_SOURCE_DIR}/assimp"
  GIT_REPOSITORY "https://github.com/assimp/assimp.git"
  GIT_TAG ""
  BUILD_IN_SOURCE 1
  CMAKE_ARGS
    "-DASSIMP_LIB_INSTALL_DIR=${CMAKE_CURRENT_SOURCE_DIR}/ext/assimp/"
    "-DASSIMP_INCLUDE_INSTALL_DIR=${CMAKE_CURRENT_SOURCE_DIR}/ext/"
    "-DASSIMP_BUILD_ALL_IMPORTERS_BY_DEFAULT=OFF"
    "-DASSIMP_BUILD_STL_IMPORTER=ON"
    "-DASSIMP_BUILD_ASSIMP_TOOLS=OFF"
    "-DASSIMP_INSTALL_PDB=OFF"
    "-DBUILD_SHARED_LIBS=OFF"
    "-DASSIMP_BUILD_TESTS=OFF"
    "-DASSIMP_BUILD_TESTING=OFF"
    "-DASSIMP_OPT_BUILD_PACKAGES=OFF"
    "-DASSIMP_BUILD_DOCS=OFF"
    "-DCMAKE_DEBUG_POSTFIX=-gd"
    "-DLIBRARY_SUFFIX=-vc141-mt"
    INSTALL_DIR "${CMAKE_CURRENT_SOURCE_DIR}/ext/")

ExternalProject_Add(glfw3
  PREFIX "${CMAKE_CURRENT_SOURCE_DIR}/glfw"
  GIT_REPOSITORY "https://github.com/glfw/glfw.git"
  GIT_TAG ""
  BUILD_IN_SOURCE 1
  CMAKE_ARGS 
    "-DCMAKE_INSTALL_PREFIX=${CMAKE_CURRENT_SOURCE_DIR}/ext/"
    "-DGLFW_BUILD_EXAMPLES=OFF"
    "-DGLFW_BUILD_TESTS=OFF"
    "-DGLFW_BUILD_DOCS=OFF"
    "-DGLFW_DOCUMENT_INTERNALS=OFF"
    "-DCMAKE_DEBUG_POSTFIX=-gd"
    "-DUSE_MSVC_RUNTIME_LIBRARY_DLL=ON")


ExternalProject_Add(glslang
  PREFIX "${CMAKE_CURRENT_SOURCE_DIR}/glslang"
  GIT_REPOSITORY "https://github.com/KhronosGroup/glslang.git"
  GIT_TAG ""
  BUILD_IN_SOURCE 1 
  CMAKE_ARGS
    "-DCMAKE_INSTALL_PREFIX=${CMAKE_CURRENT_SOURCE_DIR}/ext/"
    "-DBUILD_TESTING=OFF"
    "-DENABLE_AMD_EXTENSIONS=OFF"
    "-DENABLE_NV_EXTENSIONS=OFF"
    "-DENABLE_GLSLANG_BINARIES=OFF"
    "-DENABLE_HLSL=OFF"
 )

FILE(GLOB UTIL "src/util/*.cc" "src/util/*.cpp" "include/util/*.h" "include/util/*.hpp")
FILE(GLOB COMMON "src/common/*.h" "src/common/*.hpp")
FILE(GLOB COMMAND_FILES "src/command/*.cpp" "include/command/*.hpp")
FILE(GLOB CORE "src/core/*.cpp" "include/core/*.hpp")
FILE(GLOB RESOURCES "src/resource/*.cpp" "include/resource/*.hpp")
FILE(GLOB RENDER "src/render/*.cpp" "include/render/*.hpp")
FILE(GLOB GUI "src/gui/*.cpp" "include/gui/*.hpp")
FILE(GLOB GUI_ADDONS "src/gui/addons/*.cpp" "include/gui/addons/*.h")
FILE(GLOB IMGUI "imgui/imgui.cpp" "imgui/imgui.h" "imgui/imgui_draw.cpp" "imgui/imgui_internal.h" "imgui/imgui_demo.cpp")

INCLUDE_DIRECTORIES(${CMAKE_CURRENT_SOURCE_DIR}/include)
INCLUDE_DIRECTORIES("imgui/")
INCLUDE_DIRECTORIES("ext/")
INCLUDE_DIRECTORIES($ENV{VULKAN_SDK}/Include)

FILE(GLOB PROJECT_SOURCES "src/util/*.cpp" "src/command/*.cpp" "src/core/*.cpp" "src/render/*.cpp" "src/resource/*.cpp" "src/gui/*.cpp" "src/BaseScene.cpp")
ADD_MSVC_PRECOMPILED_HEADER("vpr_stdafx.h" "src/vpr_stdafx.cpp" ${PROJECT_SOURCES})

SOURCE_GROUP("util" FILES ${UTIL})
SOURCE_GROUP("common" FILES ${COMMON})
SOURCE_GROUP("command" FILES ${COMMAND_FILES})
SOURCE_GROUP("core" FILES ${CORE})
SOURCE_GROUP("resource" FILES ${RESOURCES})
SOURCE_GROUP("render" FILES ${RENDER})
SOURCE_GROUP("gui" FILES ${GUI})
SOURCE_GROUP("imgui addons" FILES ${GUI_ADDONS})
SOURCE_GROUP("imgui" FILES ${IMGUI})

SET(CMAKE_STATIC_LINKER_FLAGS_DEBUG "-NODEFAULTLIB 
  \"${PROJECT_SOURCE_DIR}/ext/lib/glfw3-gd.lib\" 
  \"${PROJECT_SOURCE_DIR}/ext/assimp/assimp-vc141-mt-gd.lib\"
  \"${PROJECT_SOURCE_DIR}/ext/lib/glslangd.lib\"
  \"${PROJECT_SOURCE_DIR}/ext/lib/SPVRemapperd.lib\"
  \"${PROJECT_SOURCE_DIR}/ext/lib/OSDependentd.lib\"
  \"${PROJECT_SOURCE_DIR}/ext/lib/OGLCompilerd.lib\"")
SET(CMAKE_STATIC_LINKER_FLAGS_RELEASE "-NODEFAULTLIB 
  \"${PROJECT_SOURCE_DIR}/ext/lib/glfw3.lib\" 
  \"${PROJECT_SOURCE_DIR}/ext/assimp/assimp-vc141-mt.lib\"
  \"${PROJECT_SOURCE_DIR}/ext/lib/glslang.lib\"
  \"${PROJECT_SOURCE_DIR}/ext/lib/SPVRemapper.lib\"
  \"${PROJECT_SOURCE_DIR}/ext/lib/OGLCompiler.lib\"
  \"${PROJECT_SOURCE_DIR}/ext/lib/OSDependent.lib\"")


ADD_LIBRARY(VulpesRender STATIC "include/vpr_stdafx.h" "src/vpr_stdafx.cpp" "include/ForwardDecl.hpp" "include/BaseScene.hpp" "src/BaseScene.cpp" ${IMGUI} ${GUI_ADDONS} ${UTIL} ${COMMON} ${COMMAND_FILES} ${CORE} ${RESOURCES} ${RENDER} ${GUI})


