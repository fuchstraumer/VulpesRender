<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Allocation module | VulpesRender Vulkan Primitives Library</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,600,600i%7CSource+Code+Pro:400,400i,600" />
  <link rel="stylesheet" href="m-dark+doxygen.compiled.css" />
  <link rel="icon" href="favicon-dark.png" type="image/png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#22272e" />
</head>
<body>
<header><nav id="navigation">
  <div class="m-container">
    <div class="m-row">
      <a href="index.html" id="m-navbar-brand" class="m-col-t-8 m-col-m-none m-left-m">VulpesRender <span class="m-thin">Vulkan Primitives Library</span></a>
      <div class="m-col-t-4 m-hide-m m-text-right m-nopadr">
        <a href="#search" class="m-dox-search-icon" title="Search" onclick="return showSearch()"><svg style="height: 0.9rem;" viewBox="0 0 16 16">
          <path d="m6 0c-3.3144 0-6 2.6856-6 6 0 3.3144 2.6856 6 6 6 1.4858 0 2.8463-0.54083 3.8945-1.4355-0.0164 0.33797 0.14734 0.75854 0.5 1.1504l3.2227 3.7891c0.55185 0.6139 1.4517 0.66544 2.002 0.11524 0.55022-0.55022 0.49866-1.4501-0.11524-2.002l-3.7891-3.2246c-0.39184-0.35266-0.81242-0.51469-1.1504-0.5 0.89472-1.0482 1.4355-2.4088 1.4355-3.8945 0-3.3128-2.6856-5.998-6-5.998zm0 1.5625a4.4375 4.4375 0 0 1 4.4375 4.4375 4.4375 4.4375 0 0 1-4.4375 4.4375 4.4375 4.4375 0 0 1-4.4375-4.4375 4.4375 4.4375 0 0 1 4.4375-4.4375z"/>
        </svg></a>
        <a id="m-navbar-show" href="#navigation" title="Show navigation"></a>
        <a id="m-navbar-hide" href="#" title="Hide navigation"></a>
      </div>
      <div id="m-navbar-collapse" class="m-col-t-12 m-show-m m-col-m-none m-right-m">
        <div class="m-row">
          <ol class="m-col-t-6 m-col-m-none">
            <li><a href="modules.html">Modules</a></li>
            <li><a href="namespaces.html">Namespaces</a></li>
          </ol>
          <ol class="m-col-t-6 m-col-m-none" start="3">
            <li><a href="annotated.html">Classes</a></li>
            <li><a href="files.html">Files</a></li>
            <li class="m-show-m"><a href="#search" class="m-dox-search-icon" title="Search" onclick="return showSearch()"><svg style="height: 0.9rem;" viewBox="0 0 16 16">
              <path d="m6 0c-3.3144 0-6 2.6856-6 6 0 3.3144 2.6856 6 6 6 1.4858 0 2.8463-0.54083 3.8945-1.4355-0.0164 0.33797 0.14734 0.75854 0.5 1.1504l3.2227 3.7891c0.55185 0.6139 1.4517 0.66544 2.002 0.11524 0.55022-0.55022 0.49866-1.4501-0.11524-2.002l-3.7891-3.2246c-0.39184-0.35266-0.81242-0.51469-1.1504-0.5 0.89472-1.0482 1.4355-2.4088 1.4355-3.8945 0-3.3128-2.6856-5.998-6-5.998zm0 1.5625a4.4375 4.4375 0 0 1 4.4375 4.4375 4.4375 4.4375 0 0 1-4.4375 4.4375 4.4375 4.4375 0 0 1-4.4375-4.4375 4.4375 4.4375 0 0 1 4.4375-4.4375z"/>
            </svg></a></li>
          </ol>
        </div>
      </div>
    </div>
  </div>
</nav></header>
<main><article>
  <div class="m-container m-container-inflatable">
    <div class="m-row">
      <div class="m-col-l-10 m-push-l-1">
        <h1>
          Allocation <span class="m-thin">module</span></h1>
        <p>The allocator module encompasses everything required for the operation/use of this project&#x27;s rather complex GPU memory management subsystem.</p>
        <div class="m-block m-default">
          <h3>Contents</h3>
          <ul>
            <li>
              Reference
              <ul>
                <li><a href="#nested-classes">Classes</a></li>
                <li><a href="#enum-members">Enums</a></li>
                <li><a href="#func-members">Functions</a></li>
              </ul>
            </li>
          </ul>
        </div>
<p>In Vulkan, allocating VkDeviceMemory objects for every single individual resource requiring GPU memory is wasteful, and not practical: there is a limit in each Vulkan implementation to just how many allocations can exist at one time (sometimes as low as 1024). Thus, we will instead allocate large chunks of memory when a previously unallocated memory type is requested: from there, resources (like buffers, images, etc) will bind to subregions of this larger memory object. Binding is much faster than allocation, and it is also much quicker to de-allocate resources since this only involves registering a newly freed location in this subsystem.</p><p>The allocator object is spawned as a member of the LogicalDevice class, but it can be accessed by anyone that can access a logical device. Its relatively safe to access, and should be thread-safe. Utility methods exist to simplify the creation and allocation of VkImage and VkBuffer objects as much as possible, as well.</p><p>This module also is minimally complete, at best. It is robust enough to not fail in common usage, and currently has functioned wonderfully in most tasks thrown at it. However, the todo list details stuff that still needs to be done (e.g, further splitting pools and creating some kind of defragmentation system).</p><p>Lastly, huge credit to GPU-Open as this is primarily just a slightly more object-oriented/&quot;Modern C++&quot; styled implementation of their <em>excellent</em> memory allocator. This would not have been possible without their work: <a href="https://github.com/GPUOpen-LibrariesAndSDKs/VulkanMemoryAllocator">https:/<wbr />/<wbr />github.com/<wbr />GPUOpen-LibrariesAndSDKs/<wbr />VulkanMemoryAllocator</a></p>
        <section id="nested-classes">
          <h2><a href="#nested-classes">Classes</a></h2>
          <dl class="m-dox">
            <dt>
              class <a href="classvpr_1_1_allocation.html" class="m-dox">vpr::Allocation</a>
            </dt>
            <dd><br /><a href="classvpr_1_1_allocation.html" class="m-dox">Allocation</a> class represents a singular allocation: can be a private allocation (i.e, only user of attached DeviceMemory) or a block allocation (bound to sub-region of device memory)</dd>
            <dt>
              struct <a href="structvpr_1_1_allocation_requirements.html" class="m-dox">vpr::AllocationRequirements</a>
            </dt>
            <dd>This struct is the primary item submitted to allocator methods for resource creation.</dd>
            <dt>
              class <a href="classvpr_1_1_allocator.html" class="m-dox">vpr::Allocator</a>
            </dt>
            <dd>The primary interface and class of this subsystem.</dd>
            <dt>
              class <a href="classvpr_1_1_allocation_collection.html" class="m-dox">vpr::AllocationCollection</a>
            </dt>
            <dd>An allocation collection is just a vector of MemoryBlocks of the same type.</dd>
            <dt>
              class <a href="classvpr_1_1_memory_block.html" class="m-dox">vpr::MemoryBlock</a>
            </dt>
            <dd>A <a href="classvpr_1_1_memory_block.html" class="m-dox">MemoryBlock</a> is a large contiguous region of Vulkan memory of a uniform type (device local, host coherent, host visible, etc) that other objects bind to subregions of.</dd>
            <dt>
              struct <a href="structvpr_1_1_suballocation.html" class="m-dox">vpr::Suballocation</a>
            </dt>
            <dd>During the process of finding a suitable region to bind to, we need to store things like &quot;SuballocationType&quot;, which helps keep track of the precise kind of memory we are looking for and lets us know if its optimally/linearly tiled.</dd>
            <dt>
              struct <a href="structvpr_1_1_suballocation_request.html" class="m-dox">vpr::SuballocationRequest</a>
            </dt>
            <dd>Represents an in-progress allocation that we will shortly attempt to assign a slot to.</dd>
          </dl>
        </section>
        <section id="enum-members">
          <h2><a href="#enum-members">Enums</a></h2>
          <dl class="m-dox">
            <dt>
              <span class="m-dox-wrap-bumper">enum class <a href="#gaba421ef06b1d6b910602d0180c9eff78" class="m-dox">ValidationCode</a>: uint8_t { </span><span class="m-dox-wrap"><a href="#ggaba421ef06b1d6b910602d0180c9eff78a76c3ec4c3969badcdd02e0c88b07077f" class="m-dox">VALIDATION_PASSED</a> = 0,
              <a href="#ggaba421ef06b1d6b910602d0180c9eff78a641efe802ee0e2d0cbc7a0c46e91e687" class="m-dox">NULL_MEMORY_HANDLE</a>,
              <a href="#ggaba421ef06b1d6b910602d0180c9eff78a2ceb3550d64b57a93e2896bcf767112c" class="m-dox">ZERO_MEMORY_SIZE</a>,
              <a href="#ggaba421ef06b1d6b910602d0180c9eff78a76d83e278aa0df0c5edd0e99d70ee768" class="m-dox">INCORRECT_SUBALLOC_OFFSET</a>,
              <a href="#ggaba421ef06b1d6b910602d0180c9eff78a81f141477ffccd0d5a9c6a2353348cc7" class="m-dox">NEED_MERGE_SUBALLOCS</a>,
              <a href="#ggaba421ef06b1d6b910602d0180c9eff78ac38471be1ba1406851e804110887b573" class="m-dox">FREE_SUBALLOC_COUNT_MISMATCH</a>,
              <a href="#ggaba421ef06b1d6b910602d0180c9eff78a99db430a4a1b654dc0c46b77a028d4a5" class="m-dox">USED_SUBALLOC_IN_FREE_LIST</a>,
              <a href="#ggaba421ef06b1d6b910602d0180c9eff78a4510c59ac7d838e715255649c3fd77a5" class="m-dox">FREE_SUBALLOC_SORT_INCORRECT</a>,
              <a href="#ggaba421ef06b1d6b910602d0180c9eff78a88ad6448cd6f1d495139e026eb3424dc" class="m-dox">FINAL_SIZE_MISMATCH</a>,
              <a href="#ggaba421ef06b1d6b910602d0180c9eff78a9d79688e901f5c4aa31129a2fe7f3451" class="m-dox">FINAL_FREE_SIZE_MISMATCH</a> }</span>
            </dt>
            <dd>These validation codes are returned by the memory validation routine, giving information on the error encountered.</dd>
          </dl>
        </section>
        <section id="func-members">
          <h2><a href="#func-members">Functions</a></h2>
          <dl class="m-dox">
            <dt>
              <span class="m-dox-wrap-bumper">static auto <a href="#ga8cf57df2fccbbe7a68b713d93db023c1" class="m-dox">CheckBlocksOnSamePage</a>(</span><span class="m-dox-wrap">const VkDeviceSize&amp; item_a_offset,
              const VkDeviceSize&amp; item_a_size,
              const VkDeviceSize&amp; item_b_offset,
              const VkDeviceSize&amp; page_size) -&gt; bool <span class="m-label m-flat m-primary">constexpr</span></span>
            </dt>
            <dd>Taken from the Vulkan specification, section 11.6 Essentially, we need to ensure that linear and non-linear resources are properly placed on separate memory pages so that they avoid any accidental aliasing.</dd>
            <dt>
              <span class="m-dox-wrap-bumper">static auto <a href="#ga568ec6e09a10a255e22519e4e1a4f2e3" class="m-dox">CheckBufferImageGranularityConflict</a>(</span><span class="m-dox-wrap">SuballocationType type_a,
              SuballocationType type_b) -&gt; bool <span class="m-label m-flat m-primary">constexpr</span></span>
            </dt>
            <dd>Checks to make sure the two objects of type &quot;type_a&quot; and &quot;type_b&quot; wouldn&#x27;t cause a conflict with the buffer-image granularity values.</dd>
            <dt>
              <span class="m-dox-wrap-bumper">auto <a href="#gabf0854824912bca3e22929b2407b1273" class="m-dox">operator&lt;&lt;</a>(</span><span class="m-dox-wrap">std::ostream&amp; os,
              const ValidationCode&amp; code) -&gt; std::ostream&amp;</span>
            </dt>
            <dd>This is a simple and common overload to print enum info to any stream (this also works, FYI, with easylogging++).</dd>
          </dl>
        </section>
        <section>
          <h2>Enum documentation</h2>
          <section class="m-dox-details" id="gaba421ef06b1d6b910602d0180c9eff78"><div>
            <h3>
              enum class <a href="#gaba421ef06b1d6b910602d0180c9eff78" class="m-dox-self">ValidationCode</a>: uint8_t
            </h3>
            <p>These validation codes are returned by the memory validation routine, giving information on the error encountered.</p>
<p>They will also be printed to the console, if it is enabled, and logged to the log file as well.</p>
            <table class="m-table m-fullwidth m-flat m-dox">
              <thead><tr><th style="width: 1%">Enumerators</th><th></th></tr></thead>
              <tbody>
                <tr>
                  <td><a href="#ggaba421ef06b1d6b910602d0180c9eff78a76c3ec4c3969badcdd02e0c88b07077f" class="m-dox-self" name="ggaba421ef06b1d6b910602d0180c9eff78a76c3ec4c3969badcdd02e0c88b07077f">VALIDATION_PASSED</a></td>
                  <td>
                  </td>
                </tr>
                <tr>
                  <td><a href="#ggaba421ef06b1d6b910602d0180c9eff78a641efe802ee0e2d0cbc7a0c46e91e687" class="m-dox-self" name="ggaba421ef06b1d6b910602d0180c9eff78a641efe802ee0e2d0cbc7a0c46e91e687">NULL_MEMORY_HANDLE</a></td>
                  <td>
                  <p><a href="structvpr_1_1_suballocation.html" class="m-dox">Suballocation</a>&#x27;s memory handle is invalid.</p>
                  </td>
                </tr>
                <tr>
                  <td><a href="#ggaba421ef06b1d6b910602d0180c9eff78a2ceb3550d64b57a93e2896bcf767112c" class="m-dox-self" name="ggaba421ef06b1d6b910602d0180c9eff78a2ceb3550d64b57a93e2896bcf767112c">ZERO_MEMORY_SIZE</a></td>
                  <td>
                  <p><a href="structvpr_1_1_suballocation.html" class="m-dox">Suballocation</a>&#x27;s memory size is zero.</p>
                  </td>
                </tr>
                <tr>
                  <td><a href="#ggaba421ef06b1d6b910602d0180c9eff78a76d83e278aa0df0c5edd0e99d70ee768" class="m-dox-self" name="ggaba421ef06b1d6b910602d0180c9eff78a76d83e278aa0df0c5edd0e99d70ee768">INCORRECT_SUBALLOC_OFFSET</a></td>
                  <td>
                  <p>Offset of suballocation is incorrect: it may overlap with another, or it may be placed beyond the range of the allocation.</p>
                  </td>
                </tr>
                <tr>
                  <td><a href="#ggaba421ef06b1d6b910602d0180c9eff78a81f141477ffccd0d5a9c6a2353348cc7" class="m-dox-self" name="ggaba421ef06b1d6b910602d0180c9eff78a81f141477ffccd0d5a9c6a2353348cc7">NEED_MERGE_SUBALLOCS</a></td>
                  <td>
                  <p>Two adjacent free suballoctions: merge them into one bigger suballocation.</p>
                  </td>
                </tr>
                <tr>
                  <td><a href="#ggaba421ef06b1d6b910602d0180c9eff78ac38471be1ba1406851e804110887b573" class="m-dox-self" name="ggaba421ef06b1d6b910602d0180c9eff78ac38471be1ba1406851e804110887b573">FREE_SUBALLOC_COUNT_MISMATCH</a></td>
                  <td>
                  <p>We found more free suballocations while validating than there are in the free suballocation list.</p>
                  </td>
                </tr>
                <tr>
                  <td><a href="#ggaba421ef06b1d6b910602d0180c9eff78a99db430a4a1b654dc0c46b77a028d4a5" class="m-dox-self" name="ggaba421ef06b1d6b910602d0180c9eff78a99db430a4a1b654dc0c46b77a028d4a5">USED_SUBALLOC_IN_FREE_LIST</a></td>
                  <td>
                  <p>Non-free suballocation in free suballocation list.</p>
                  </td>
                </tr>
                <tr>
                  <td><a href="#ggaba421ef06b1d6b910602d0180c9eff78a4510c59ac7d838e715255649c3fd77a5" class="m-dox-self" name="ggaba421ef06b1d6b910602d0180c9eff78a4510c59ac7d838e715255649c3fd77a5">FREE_SUBALLOC_SORT_INCORRECT</a></td>
                  <td>
                  <p>Free suballocation list is sorted by available space descending: sorting is incorrect and smaller free region is before larger free region.</p>
                  </td>
                </tr>
                <tr>
                  <td><a href="#ggaba421ef06b1d6b910602d0180c9eff78a88ad6448cd6f1d495139e026eb3424dc" class="m-dox-self" name="ggaba421ef06b1d6b910602d0180c9eff78a88ad6448cd6f1d495139e026eb3424dc">FINAL_SIZE_MISMATCH</a></td>
                  <td>
                  <p>Calculated offset as sum of all suballoc sizes is not equal to allocations total size.</p>
                  </td>
                </tr>
                <tr>
                  <td><a href="#ggaba421ef06b1d6b910602d0180c9eff78a9d79688e901f5c4aa31129a2fe7f3451" class="m-dox-self" name="ggaba421ef06b1d6b910602d0180c9eff78a9d79688e901f5c4aa31129a2fe7f3451">FINAL_FREE_SIZE_MISMATCH</a></td>
                  <td>
                  <p>Calculated total available size doesn&#x27;t match stored available size.</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div></section>
        </section>
        <section>
          <h2>Function documentation</h2>
          <section class="m-dox-details" id="ga8cf57df2fccbbe7a68b713d93db023c1"><div>
            <h3>
              <span class="m-dox-wrap-bumper">static bool </span><span class="m-dox-wrap"><span class="m-dox-wrap-bumper"><a href="#ga8cf57df2fccbbe7a68b713d93db023c1" class="m-dox-self">CheckBlocksOnSamePage</a>(</span><span class="m-dox-wrap">const VkDeviceSize&amp; item_a_offset,
              const VkDeviceSize&amp; item_a_size,
              const VkDeviceSize&amp; item_b_offset,
              const VkDeviceSize&amp; page_size) <span class="m-label m-primary">constexpr</span></span></span>
            </h3>
            <p>Taken from the Vulkan specification, section 11.6 Essentially, we need to ensure that linear and non-linear resources are properly placed on separate memory pages so that they avoid any accidental aliasing.</p>
            <table class="m-table m-fullwidth m-flat">
              <thead>
                <tr><th colspan="2">Parameters</th></tr>
              </thead>
              <tbody>
                <tr>
                  <td style="width: 1%">item_a_offset</td>
                  <td>non-linear object&#x27;s offset</td>
                </tr>
                <tr>
                  <td>item_a_size</td>
                  <td>non-linear object&#x27;s size</td>
                </tr>
                <tr>
                  <td>item_b_offset</td>
                  <td>linear object&#x27;s offset</td>
                </tr>
                <tr>
                  <td>page_size</td>
                  <td>almost universally tends to be the bufferImageGranularity value retrieved by the parent <a href="classvpr_1_1_allocator.html" class="m-dox">Allocator</a> class.</td>
                </tr>
              </tbody>
            </table>
<p>Linear resources are just those that could be read like any other memory region, without any particular optimization for size or access speed. Optimally tiled resources are those that are tiled either by the hardware drivers, or the Vulkan implementation. Think of things like Z-Order curve encoding for texture data, or block-based compression for DDS/KTX texture formats.</p>
          </div></section>
          <section class="m-dox-details" id="ga568ec6e09a10a255e22519e4e1a4f2e3"><div>
            <h3>
              <span class="m-dox-wrap-bumper">static bool </span><span class="m-dox-wrap"><span class="m-dox-wrap-bumper"><a href="#ga568ec6e09a10a255e22519e4e1a4f2e3" class="m-dox-self">CheckBufferImageGranularityConflict</a>(</span><span class="m-dox-wrap">SuballocationType type_a,
              SuballocationType type_b) <span class="m-label m-primary">constexpr</span></span></span>
            </h3>
            <p>Checks to make sure the two objects of type &quot;type_a&quot; and &quot;type_b&quot; wouldn&#x27;t cause a conflict with the buffer-image granularity values.</p>
<p>Returns true if conflict, false if no conflict. This is unlike the CheckBlocksOnSamePage method, in that it doesn&#x27;t check memory location and alignment values, merely comparing the resource types for incompatabilities. This is used to avoid the more detailed checks like CheckBlocksOnSamePage (and the corrections required if this also fails)</p><p>BufferImageGranularity specifies interactions between linear and non-linear resources, so we check based on those.</p>
          </div></section>
          <section class="m-dox-details" id="gabf0854824912bca3e22929b2407b1273"><div>
            <h3>
              <span class="m-dox-wrap-bumper">std::ostream&amp; </span><span class="m-dox-wrap"><span class="m-dox-wrap-bumper"><a href="#gabf0854824912bca3e22929b2407b1273" class="m-dox-self">operator&lt;&lt;</a>(</span><span class="m-dox-wrap">std::ostream&amp; os,
              const ValidationCode&amp; code)</span></span>
            </h3>
            <p>This is a simple and common overload to print enum info to any stream (this also works, FYI, with easylogging++).</p>
<p>A note to make, however, is that compilers running at W4/Wall warning levels will warn that this method is unreferenced in release mode, if validation is not forced. As the memory verification routine is not used in this case, much of that code will fold away but should still be left in for debug builds.</p>
          </div></section>
        </section>
      </div>
    </div>
  </div>
</article></main>
<div class="m-dox-search" id="search">
  <a href="#!" onclick="return hideSearch()"></a>
  <div class="m-container">
    <div class="m-row">
      <div class="m-col-m-8 m-push-m-2">
        <div class="m-dox-search-header m-text m-small">
          <div><span class="m-label m-default">Tab</span> / <span class="m-label m-default">T</span> to search, <span class="m-label m-default">Esc</span> to close</div>
          <div id="search-symbolcount">&hellip;</div>
        </div>
        <div class="m-dox-search-content">
          <input type="search" id="search-input" placeholder="Loading &hellip;" disabled="disabled" autofocus="autofocus" />
          <noscript class="m-text m-danger m-text-center">Unlike everything else in the docs, the search functionality <em>requires</em> JavaScript.</noscript>
          <div id="search-help" class="m-text m-dim m-text-center">
            Search for symbols, directories, files, pages or modules. You can omit any
            prefix from the symbol or file path; adding a <code>:</code> or <code>/</code>
            suffix lists all members of given symbol or directory. Navigate through the
            list using <span class="m-label m-dim">&darr;</span> and
            <span class="m-label m-dim">&uarr;</span>, press
            <span class="m-label m-dim">Enter</span> to go.
          </div>
          <div id="search-notfound" class="m-text m-warning m-text-center">Sorry, nothing was found.</div>
          <ul id="search-results"></ul>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="search.js"></script>
<script src="searchdata.js" async="async"></script>
<footer><nav>
  <div class="m-container">
    <div class="m-row">
      <div class="m-col-l-10 m-push-l-1">
        <p>VulpesRender Vulkan Primitives Library. Created by <a href="https://doxygen.org/">Doxygen</a> 1.8.14 and <a href="https://mcss.mosra.cz/">m.css</a>.</p>
      </div>
    </div>
  </div>
</nav></footer>
</body>
</html>